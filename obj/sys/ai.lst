ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 1.
Hexadecimal [16-Bits]



                              1 ;===================================================================================================================================================
                              2 ; CPCTelera functions
                              3 ;===================================================================================================================================================
                              4 .globl cpct_scanKeyboard_f_asm
                              5 .globl cpct_isKeyPressed_asm
                              6 
                              7 ;===================================================================================================================================================
                              8 ; Public functions
                              9 ;===================================================================================================================================================
                             10 .globl _man_entityForAllMatching
                             11 .globl _m_game_createEnemy
                             12 
                             13 .globl _m_functionMemory
                             14 .globl _m_matchedEntity
                             15 
                             16 
                             17 ;===================================================================================================================================================
                             18 ; Manager data
                             19 ;===================================================================================================================================================
   0000                      20 _sys_ai_behaviourMemory::
   0000                      21     .ds 2
                             22 
                             23 ;===================================================================================================================================================
                             24 ; FUNCION _sys_ai_update
                             25 ; Llama a la inversión de control para updatear el comportamiento de 
                             26 ; las entidades que coincida con e_type_movable
                             27 ; NO llega ningun dato
                             28 ;===================================================================================================================================================
   0002                      29 _sys_ai_update::
   0002 21 11 00      [10]   30     ld hl, #_sys_ai_updateOneEntity
   0005 22 00 00      [16]   31     ld (_m_functionMemory), hl
   0008 21 00 00      [10]   32     ld hl , #_m_matchedEntity 
   000B 36 0A         [10]   33     ld (hl), #0x0A ;;  e_type_movable | e_type_ai
   000D CD 00 00      [17]   34     call _man_entityForAllMatching
   0010 C9            [10]   35     ret
                             36 
                             37 ;===================================================================================================================================================
                             38 ; FUNCION _sys_ai_updateOneEntity
                             39 ; Busca el comportamiento de la entidad y lo ejecuta 
                             40 ; HL : LA entidad a updatear
                             41 ;===================================================================================================================================================
   0011                      42 _sys_ai_updateOneEntity::    
                             43     ; ex de, hl
   0011 3E 09         [ 7]   44     ld a,#0x09
   0013                      45     searchBehaviour:
   0013 23            [ 6]   46         inc hl
   0014 3D            [ 4]   47         dec a
   0015 20 FC         [12]   48         jr NZ, searchBehaviour
                             49     
   0017 DD 21 39 00   [14]   50     ld ix, #updatedOneEntity
   001B DD E5         [15]   51     push ix
                             52 
                             53     ;ex de, hl
   001D E5            [11]   54     push hl
   001E 7E            [ 7]   55     ld a, (hl)
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 2.
Hexadecimal [16-Bits]



   001F 21 00 00      [10]   56     ld hl, #_sys_ai_behaviourMemory
   0022 77            [ 7]   57     ld (hl),a
   0023 E1            [10]   58     pop hl
   0024 E5            [11]   59     push hl
   0025 23            [ 6]   60     inc hl
   0026 7E            [ 7]   61     ld a, (hl)
   0027 21 00 00      [10]   62     ld hl, #_sys_ai_behaviourMemory
   002A 23            [ 6]   63     inc hl
   002B 77            [ 7]   64     ld (hl),a
   002C E1            [10]   65     pop hl
                             66 
   002D 3E 09         [ 7]   67     ld a,#0x09
   002F                      68     searchType:
   002F 2B            [ 6]   69         dec hl
   0030 3D            [ 4]   70         dec a
   0031 20 FC         [12]   71         jr NZ, searchType
                             72 
   0033 DD 2A 00 00   [20]   73     ld ix, (#_sys_ai_behaviourMemory)
   0037 DD E9         [ 8]   74     jp (ix)
                             75 
   0039                      76     updatedOneEntity:
                             77     
   0039 C9            [10]   78     ret
                             79 
                             80 
                             81 ;===================================================================================================================================================
                             82 ; FUNCION _sys_ai_behaviourMothership
                             83 ; Comportamiento de la MotherShip
                             84 ; 1º Intenta crear un enemigo hijo
                             85 ; 2º Se mueve de derecha a izquierda hasta los bordes
                             86 ; HL : Entidad a updatear
                             87 ;===================================================================================================================================================
   003A                      88 _sys_ai_behaviourMothership::
                             89 
                             90     ;;Si esta en x=20(decimal) intenta crear un enemigo
   003A 23            [ 6]   91     inc hl
   003B 7E            [ 7]   92     ld a,(hl)
   003C 2B            [ 6]   93     dec hl
   003D D6 14         [ 7]   94     sub #0x14
   003F 20 03         [12]   95     jr NZ,notCreateEnemy
                             96 
   0041 CD 00 00      [17]   97     call _m_game_createEnemy
   0044                      98     notCreateEnemy: 
   0044 CD 48 00      [17]   99     call _sys_ai_behaviourLeftRight
                            100 
   0047 C9            [10]  101     ret
                            102 
                            103 
                            104 ;===================================================================================================================================================
                            105 ; FUNCION _sys_ai_behaviourLeftRight
                            106 ; Si llega a alguno de los bordes establece su velocidad en la direccion contraria
                            107 ; HL : Entidad a updatear
                            108 ;===================================================================================================================================================
   0048                     109 _sys_ai_behaviourLeftRight::
   0048 3E 50         [ 7]  110     ld a, #0x50
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 3.
Hexadecimal [16-Bits]



   004A 23            [ 6]  111     inc hl
   004B 46            [ 7]  112     ld b,(hl) ;; b = x
   004C 23            [ 6]  113     inc hl
   004D 23            [ 6]  114     inc hl
   004E 96            [ 7]  115     sub (hl)  ;; a = right bound
   004F 23            [ 6]  116     inc hl
   0050 23            [ 6]  117     inc hl 
   0051 04            [ 4]  118     inc b
   0052 05            [ 4]  119     dec b
   0053 28 09         [12]  120     jr Z, leftPart
                            121 
   0055 4F            [ 4]  122     ld c,a
   0056 78            [ 4]  123     ld a,b
   0057 41            [ 4]  124     ld b,c
                            125 
   0058 90            [ 4]  126     sub b
   0059 28 08         [12]  127     jr Z, rightPart
                            128 
   005B C3 65 00      [10]  129     jp exitUpdate
   005E                     130     leftPart:
   005E 36 01         [10]  131         ld (hl), #0x01
   0060 C3 65 00      [10]  132         jp exitUpdate
                            133 
   0063                     134     rightPart:
   0063 36 FF         [10]  135         ld (hl), #0xFF
                            136 
   0065                     137     exitUpdate:
   0065 C9            [10]  138     ret
